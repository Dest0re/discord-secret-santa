import discord
from discord.ext import commands
from peewee import fn

from utils.embed import TitledText
from model import User, DiscordProfile, Present, GamePackage


user_list = ['<@368953518196785152>', '<@332938926375305218>', '<@360858402911420416>']


class GoodByeBot(commands.Bot):
    def __init__(self, *args, **kwargs):
        self._is_ready = False

        super().__init__(*args, **kwargs)

    async def on_ready(self):
        if not self._is_ready:
            print(f'Logged in Discord as {self.user}')

            self._is_ready = True

            query = (
                User
                .select()
                .join(Present)
                .join(GamePackage)
                .where(Present.paid == True)
                .group_by(User.id)
                .having(fn.SUM(GamePackage.price) >= 500, User.discord_profile != None)
            )

            for user in set(query):
                
                discord_user = await self.fetch_user(user.discord_profile.discord_id)

                if discord_user:
                    embed_text = (
                        """–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ!

                        –î—Ä—É–∑—å—è, –ø—É—Å—Ç—å –Ω–µ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º –∏ –≤—ã–π–¥—è –∑–∞ –≤—Å—è–∫–∏–µ —Å—Ä–æ–∫–∏, –Ω–æ –º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏ –Ω–∞—à –∏–≤–µ–Ω—Ç "–¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞"!!!
                        
                        –ú—ã –æ—á–µ–Ω—å —Ä–∞–¥—ã, —á—Ç–æ –≤—Å—ë –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—ã –¥–∞–∂–µ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç–µ, —Å–∫–æ–ª—å–∫–æ –Ω–µ—Ä–≤–æ–≤ –∏ —Å–∏–ª –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –±–æ—Ç–∞ –∏ —Ö–æ—Å—Ç –∏–≤–µ–Ω—Ç–∞. –ù–µ –≥–æ–≤–æ—Ä—è —É–∂–µ –æ –¥–µ–Ω–µ–∂–Ω–æ–π –≤–æ–ª–æ–∫–∏—Ç–µ –∏ —Ä–∞—Å—Ö–æ–¥–∞—Ö, –±–µ–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª–æ –Ω–∏–∫—É–¥–∞!
                        
                        –¢–µ–º –Ω–µ –º–µ–Ω–µ–µ, –º—ã –∏—Å–∫—Ä–µ–Ω–Ω–µ –Ω–∞–¥–µ–µ–º—Å—è, —á—Ç–æ –≤–∞–º –≤—Å—ë –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏ —á—Ç–æ –≤—ã –æ–∫–∞–∑–∞–ª–∏—Å—å –¥–æ–≤–æ–ª—å–Ω—ã –∏–≥—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–ª–µ—Ç–µ–ª–∏ –≤–∞–º –≤ –æ—Ç–≤–µ—Ç.
                        
                        –í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç! –í —Å–≤—è–∑–∏ —Å–æ —Å–ª–æ–∂–∏–≤—à–µ–π—Å—è —Å–∏—Ç—É–∞—Ü–∏–µ–π (–∞ –Ω–∞—Å –∑–∞–±–∞–Ω–∏–ª–∏ –≤ —Å—Ç–∏–º–µ –¥–æ –∫–æ–Ω—Ü–∞ —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∏) –º–Ω–æ–≥–∏–µ –∏–≥—Ä—ã –ø–æ–¥–æ—Ä–æ–∂–∞–ª–∏ –∫—Ä–∞—Ç–Ω–æ. –ò –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–±—è—Ç–∞ –Ω–µ —Å—Ç–∞–ª–∏ –≤—ã–±–∏—Ä–∞—Ç—å –Ω–æ–≤—ã–µ –∏–≥—Ä—ã, –∞ –¥–æ–∫–∏–Ω—É–ª–∏ –¥–µ–Ω—è–∫, —á—Ç–æ–±—ã –≤—Å—ë-—Ç–∞–∫–∏ –ø–æ–¥–∞—Ä–∏—Ç—å —Å—Ç–∞—Ä—ã–µ. –ò –º–æ–∂–µ—Ç–µ –ø–æ–≤–µ—Ä–∏—Ç—å, —ç—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –¥–µ–Ω—å–≥–∏.
                        –¢–∞–∫ —á—Ç–æ —Å–∫–∞–∂–µ–º –∏–º "–°–ø–∞—Å–∏–±–æ!": """ 
                        + ', '.join(user_list) + 
                        """!
                        
                        –°–ø–∞—Å–∏–±–æ –∏ –≤–∞–º –≤—Å–µ–º –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —ç—Ç–æ–º –ø–æ —Å—É—Ç–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∏–≤–µ–Ω—Ç–µ!
                        –û—Å—Ç–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–æ–º—É –¥–∞—Ä–∏—Ç—å –ø–µ—á–µ–Ω—å–∫–∏? üç™
                        
                        –î–ª—è –≤–∞—Å:

                        **–ü–∏—Å–∞–ª–∏ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–ª–∏ –±–æ—Ç–∞, –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –∏–≤–µ–Ω—Ç**: 
                        <@350206214782582784>, <@141424884466057217> 
                        
                        **–†–∏—Å–æ–≤–∞–ª –±–æ—Ç—É –∞–≤–∞—Ç–∞—Ä–∫—É**: <@332938926375305218> 
                        
                        **–ü–æ–¥–∞—Ä–∏–ª –í–∞–º –∏–≥—Ä—É**: *???*


                        –° –Ω–æ–≤—ã–º 2022 –≥–æ–¥–æ–º! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!



                        –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∏–≤–µ–Ω—Ç–∞: 
                        """ 
                        + ', '.join(map(lambda u: f'<@{u.discord_profile.discord_id}>', query))
                    )

                    await discord_user.send(embed=TitledText('–£—Ä–∞!!!!!!', embed_text))
            
